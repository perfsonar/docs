
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Deploying a Central Measurement Archive &#8212; perfSONAR Toolkit 4.4.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/perfsonar.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Clustering a Measurement Archive" href="multi_ma_clustering.html" />
    <link rel="prev" title="MeshConfig to pSConfig Migration Guide" href="psconfig_meshconfig_migrate.html" /> 
  </head><body>
    <header>
        <div class="headerContents">
          <a href="index.html" border="0"><img src="_static/perfSONAR-header.gif"></a>
          <div class="acctSearchContainer">
              <section id="searchBox" class="searchBox">
                  <!--Use of this code assumes agreement with the Google Custom Search Terms of Service. -->
                  <!--The terms of service are available at http://www.google.com/cse/docs/tos.html -->
                  <form action="search.html" id="cse-search-box" method="get">
                    <input type="text" name="q" size="25" class="searchInput" placeholder="Search"/>
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                  </form>
              </section>
         </div>
        </div>
    </header>
    <div style="display:block;clear:both;">
    
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="multi_ma_clustering.html" title="Clustering a Measurement Archive"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="psconfig_meshconfig_migrate.html" title="MeshConfig to pSConfig Migration Guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">perfSONAR Toolkit 4.4.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="deploying-a-central-measurement-archive">
<h1>Deploying a Central Measurement Archive<a class="headerlink" href="#deploying-a-central-measurement-archive" title="Permalink to this headline">¶</a></h1>
<p>Measurement results from your regular tests are stored in a <strong>measurement archive (MA)</strong>. This leads to the definition of two categories of hosts:</p>
<ol class="arabic simple">
<li><p>The <strong>measurement host</strong> that runs regular tests such as throughput, one-way latency, ping and traceroute measurements.</p></li>
<li><p>The <strong>archive host</strong> that stores the results from the measurement host(s)</p></li>
</ol>
<p>By default the perfSONAR Toolkit is both measurement host AND archive host. It comes installed with both the regular testing infrastructure and the measurement archive software. The measurement archive stores all the results from measurements defined in the regular testing configuration of the local host. In most cases, this is an adequate storage strategy.</p>
<p>As an alternative, you may decide to separate your measurement hosts and archive host(s). This allows a single “centralized” archive host to store results from multiple measurement hosts. A few use cases where this may be desirable are as follows:</p>
<ul class="simple">
<li><p>Your measurement hosts are on less powerful (and likely lower cost) hardware that you don’t want having the overhead of running the measurement archive. The measurement archive has higher hardware requirements than the measurement tools, so removing it can result in considerable resource savings.</p></li>
<li><p>Your site has the experience and the infrastructure to manage large databases that you would like to leverage for storing measurement results on a dedicated archive host.</p></li>
<li><p>You want to store results in multiple places. For example, you may store your results locally but also store them in a central archive where complex analysis tools operate on all the data from multiple hosts in one location.</p></li>
</ul>
<p>Those are just a few examples. If you think a central measurement archive is right for your measurement strategy, then read the remainder of this document for instructions on how to configure both your archive host and measurement hosts.</p>
<div class="section" id="installing-the-measurement-archive-software">
<h2>Installing the Measurement Archive Software<a class="headerlink" href="#installing-the-measurement-archive-software" title="Permalink to this headline">¶</a></h2>
<p>The measurement archive is implemented using a software package named <em>esmond</em>. The following installation options are available for installing esmond:</p>
<ol class="arabic simple">
<li><p>As part of the perfSONAR <em>core</em>, <em>toolkit</em> or <em>centralmanagement</em> bundles. See <a class="reference internal" href="install_options.html"><span class="doc">perfSONAR Installation Options</span></a> for more information.</p></li>
<li><p>As a standalone package on any perfSONAR supported operating system (e.g. <code class="docutils literal notranslate"><span class="pre">yum</span> <span class="pre">install</span> <span class="pre">esmond</span></code>, <code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">esmond</span></code>)</p></li>
</ol>
</div>
<div class="section" id="authenticating-measurement-hosts">
<h2>Authenticating Measurement Hosts<a class="headerlink" href="#authenticating-measurement-hosts" title="Permalink to this headline">¶</a></h2>
<p>Measurement hosts need to authenticate to the measurement archive when they register data. This is implemented in esmond using one of two methods:</p>
<ol class="arabic simple">
<li><p>An API key that is passed in the HTTP header of all requests.</p></li>
<li><p>Using IP based authentication</p></li>
</ol>
<p>The remainder of this section describes how to setup both type of accounts.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may have a combination of the above where some accounts authenticate based on IP address and others based on API key.  If a request matches both an API key account and an IP address account, then the API account will be tried first. If the API key authentication fails, then it will fallback to the IP address account.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is <strong>highly recommended</strong> you run your measurement archive server with HTTPS. This encrypts transfers and protects the API key (if applicable) from being exposed in plain text since it is just in the HTTP header. See the Apache HTTPD documentation for information on how to configure HTTPS.</p>
</div>
<div class="section" id="authenticating-by-api-key">
<span id="multi-ma-install-intro"></span><h3>Authenticating by API Key<a class="headerlink" href="#authenticating-by-api-key" title="Permalink to this headline">¶</a></h3>
<p>As an archive administrator you may create a username, generate an API key, and assign the needed permissions to register data with the commands below:</p>
<ol class="arabic">
<li><p>As priviledged user run the commands below replacing <em>example_user</em> with the username of the account you would like to create:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">esmond_manage</span> <span class="n">add_ps_metadata_post_user</span> <span class="n">example_user</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">esmond_manage</span> <span class="n">add_timeseries_post_user</span> <span class="n">example_user</span>
</pre></div>
</div>
</li>
<li><p>After running the commands above you should see the generated API key in the output (if not, re-run the commands above and they will re-show you the generated API key without affecting the user you just created). An example of the output line showing the API key (<em>9130962c6b38722c0b9968e6903e1927e94e16fd</em> in this example) is below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Key</span><span class="p">:</span> <span class="mi">9130962</span><span class="n">c6b38722c0b9968e6903e1927e94e16fd</span> <span class="k">for</span> <span class="n">example_user</span>
</pre></div>
</div>
</li>
</ol>
<p>At this point provide the administrator of the measurement host wishing to register datagenerated API key.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is no technical limitation preventing multiple measurement hosts from sharing an API key. It is up to you as an archive administrator to make a decision about whether you will share accounts between multiple measurement hosts or require unique accounts for each. It is the responsibility of both you and the measurement host administrator to follow best commons security practices and common sense in preventing unwanted parties from obtaining these credentials.</p>
</div>
</div>
<div class="section" id="authenticating-by-ip-address">
<span id="multi-ma-install-auth-ip"></span><h3>Authenticating by IP Address<a class="headerlink" href="#authenticating-by-ip-address" title="Permalink to this headline">¶</a></h3>
<p>As an archive administrator you may create an account that authenticates based on IP address. You may specify an IP mask so that multiple addresses may authenticate. This can be particularly useful in large deployments of measurement hosts in a small set of subnets as it does not require a password (API key) to be defined for each host in their tasks file. As such, automated configuration is made easier by this authentication method. The commands for adding an account that authenticates based on IP are as follows:</p>
<ol class="arabic">
<li><p>As priviledged user run the commands below to create the account. You must provide a username (replacing <em>example_user</em>) as the first argument. This is simply used internally to identify the set of permissions associated with the IP addresses. After that may be one or more IP addresses in the form of <em>X.X.X.X</em> or <em>X.X.X.X/Y</em> where <em>X</em> is each octet and <em>Y</em> is the subnet. If Y is not specified it defaults to 32 (i.e. only the exact IP address provided matches). The example below will allow the host <em>10.0.1.1</em> or any host in the <em>10.0.2.0/24</em> subnet to register data to esmond:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">esmond_manage</span> <span class="n">add_user_ip_address</span> <span class="n">example_user</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">1.1</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">2.0</span><span class="o">/</span><span class="mi">24</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="configuring-measurement-hosts">
<h2>Configuring Measurement Hosts<a class="headerlink" href="#configuring-measurement-hosts" title="Permalink to this headline">¶</a></h2>
<p>Each measurement host must be configured to register its data to the central archive. This is done by configuring the <a class="reference internal" href="psconfig_pscheduler_agent.html"><span class="doc">pSConfig pScheduler Agent</span></a> to use the archive. The exact approach depends largely with how you are reading your template and which tasks you want to send to the central archive.</p>
<p>One approach is to define the archive in the pSConfig template being used. In that case, the pSConfig template is going to need a section similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;archives&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;example_esmond_archive&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;archiver&quot;</span><span class="p">:</span> <span class="s2">&quot;esmond&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;measurement-agent&quot;</span><span class="p">:</span> <span class="s2">&quot;{</span><span class="si">% s</span><span class="s2">cheduled_by_address %}&quot;</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ma.example.perfsonar.net/esmond/perfsonar/archive/&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is highly recommended you set the <code class="docutils literal notranslate"><span class="pre">measurement-agent</span></code> field to the template variable <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">scheduled_by_address</span> <span class="pre">%}</span></code> for esmond archives as it ensures the requester of the measurement is properly recorded. See <a class="reference internal" href="psconfig_templates_vars.html#psconfig-templates-vars-scheduled-by-address"><span class="std std-ref">scheduled_by_address Variable</span></a> for more details on this variable.</p>
</div>
<p>The full set of options for the <code class="docutils literal notranslate"><span class="pre">data</span></code> section of an <em>archive</em> object of type <em>esmond</em> are detailed <a class="reference internal" href="pscheduler_ref_archivers.html#pscheduler-ref-archivers-archivers-esmond"><span class="std std-ref">here</span></a>.  The defined <code class="docutils literal notranslate"><span class="pre">tasks</span></code> section will need to reference the archive defined above for those tasks to be stored. See <a class="reference internal" href="psconfig_templates_intro.html"><span class="doc">Introduction to pSConfig Templates</span></a> for information on how tasks and archives link together if that is not clear.</p>
<p>The above example does not define an API key for authentication. It is possible to set the API key using the <code class="docutils literal notranslate"><span class="pre">_auth_token</span></code> field. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;archives&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;example_esmond_archive_with_key&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;archiver&quot;</span><span class="p">:</span> <span class="s2">&quot;esmond&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;measurement-agent&quot;</span><span class="p">:</span> <span class="s2">&quot;{</span><span class="si">% s</span><span class="s2">cheduled_by_address %}&quot;</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ma.example.perfsonar.net/esmond/perfsonar/archive/&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_auth-token&quot;</span><span class="p">:</span> <span class="s2">&quot;35dfc21ebf95a6deadbeef83f1e052fbadcafe57&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>It is only recommended you set the</strong> <code class="docutils literal notranslate"><span class="pre">_auth-token</span></code> <strong>if your template is a file on the local system that will never be published to the web.</strong> This is to protect your API key from being exposed. See <a class="reference internal" href="psconfig_pscheduler_agent.html#psconfig-pscheduler-agent-templates-local"><span class="std std-ref">Local Templates</span></a> for how to setup local templates. Alternatively see <a class="reference internal" href="psconfig_pscheduler_agent.html#psconfig-pscheduler-agent-modify-archives"><span class="std std-ref">Configuring Default Archives</span></a> for information on how to define a default archiver locally for all tasks. Finally, if you have a remote template and would like to set the <code class="docutils literal notranslate"><span class="pre">_auth-token</span></code> after the agent downloads the template see <a class="reference internal" href="psconfig_pscheduler_agent.html#psconfig-pscheduler-agent-modify-transform-all"><span class="std std-ref">Transforming All Remote Templates</span></a> and <a class="reference internal" href="psconfig_pscheduler_agent.html#psconfig-pscheduler-agent-modify-transform-one"><span class="std std-ref">Transforming Individual Remote Templates</span></a>.</p>
<p>If you are using a remote pSConfig template that has your archive defined in it, make sure you use the <code class="docutils literal notranslate"><span class="pre">--configure-archives</span></code> option of <code class="docutils literal notranslate"><span class="pre">psconfig</span> <span class="pre">remote</span> <span class="pre">add</span></code> when you add the URL to the template. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psconfig</span> <span class="n">remote</span> <span class="n">add</span> <span class="o">--</span><span class="n">configure</span><span class="o">-</span><span class="n">archives</span> <span class="n">URL</span>
</pre></div>
</div>
<p>If the option is not included then the archive will be ignored.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <nav id="channelNav" class="channelNav">
                
                <ul>
<li><a class="reference internal" href="#">Deploying a Central Measurement Archive</a><ul>
<li><a class="reference internal" href="#installing-the-measurement-archive-software">Installing the Measurement Archive Software</a></li>
<li><a class="reference internal" href="#authenticating-measurement-hosts">Authenticating Measurement Hosts</a><ul>
<li><a class="reference internal" href="#authenticating-by-api-key">Authenticating by API Key</a></li>
<li><a class="reference internal" href="#authenticating-by-ip-address">Authenticating by IP Address</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuring-measurement-hosts">Configuring Measurement Hosts</a></li>
</ul>
</li>
</ul>

                <ul>
                  <li>
                  <a href="psconfig_meshconfig_migrate.html">Previous topic</a>
                  <ul><li><a href="psconfig_meshconfig_migrate.html" title="previous chapter">MeshConfig to pSConfig Migration Guide</a></li></ul>
                  </li>
                </ul>
                  <ul>
                      <li>
                      <a href="multi_ma_clustering.html">Next topic</a>
                      <ul><li><a href="multi_ma_clustering.html" title="next chapter">Clustering a Measurement Archive</a></li></ul>
                      </li>
                  </ul>
                
                
            </nav>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="multi_ma_clustering.html" title="Clustering a Measurement Archive"
             >next</a> |</li>
        <li class="right" >
          <a href="psconfig_meshconfig_migrate.html" title="MeshConfig to pSConfig Migration Guide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">perfSONAR Toolkit 4.4.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <footer id="fat">
        <div class="footerContents">
            <nav id="fatFooterNav" class="fatFooterNav">
                <ul id="menu-partners" class="menu depth-0">
                    <li id="footer-partner-text" class="partner-menu">
                        perfSONAR 
                        <br>
                        partners 
                        <br>
                        include: 
                    </li>
    
                <li id="footer-partner-esnet" class="partner-menu">
                    <a href="http://www.es.net/" title="Visit DOE's Energy Sciences Network"><img src="_static/ESnet-ps.png" alt="" style="border:none;"></a> </li>
                
                <li id="footer-partner-geant" class="partner-menu">
                    <a href="http://www.geant.org/" title="Visit GEANT"><img src="_static/geant-ps.png" alt="" style="border:none;"/></a> </li>
        
                <li id="footer-partner-iu" class="partner-menu">
                    <a href="http://www.iu.edu/" title="Visit Indiana University"><img src="_static/IU-ps.png" alt="" style="border:none;"></a> </li>

                <li id="footer-partner-i2" class="partner-menu">
                    <a href="http://www.internet2.edu/" title="Visit Internet2"><img src="_static/I2-ps.png" alt="" style="border:none;"></a> </li>
					
				<li id="footer-partner-rnp" class="partner-menu">
                    <a href="https://www.rnp.br/en" title="Visit RNP"><img src="_static/rnp.png" alt="" style="border:none;"></a> </li>
                
                <li id="footer-partner-um" class="partner-menu">
                    <a href="http://www.umich.edu/" title="Visit University of Michigan"><img src="_static/UM-ps.png" alt="" style="border:none;"></a> </li>

                </ul>

            </nav>
            <nav id="minFooterNav" class="minFooterNav">
                <span class="copyright">PERFormance Service Oriented Network monitoring ARchitecture </span>
            </nav>
          
        </div> <!-- /footerContents -->
    </footer>
    
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, perfSONAR Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>